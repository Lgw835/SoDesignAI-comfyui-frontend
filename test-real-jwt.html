<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real JWT Token Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.4;
        }
        .token-section {
            word-break: break-all;
            font-family: monospace;
            font-size: 11px;
            background: #f1f3f4;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
    </style>
</head>
<body>
    <h1>Real JWT Token Analysis</h1>
    
    <div class="container info">
        <h3>Token Information</h3>
        <p>Analyzing the provided JWT token from SoDesign.AI</p>
    </div>

    <div id="tokenAnalysis"></div>
    <div id="comfyUITest"></div>

    <script>
        // The real JWT token provided
        const realToken = "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJTb0Rlc2lnbi5BSSIsImF1ZCI6InNvZGVzaWduLXVzZXJzIiwic3ViIjoiNjgxYTJmZGFhMjZkY2ZhYWJkMzZjZjYxIiwiaWF0IjoxNzUxODczMDE0LCJleHAiOjE3NTE4NzQ4MTQsInR5cGUiOiJhY2Nlc3MiLCJ1c2VyX2lkIjoiNjgxYTJmZGFhMjZkY2ZhYWJkMzZjZjYxIiwidXNlcm5hbWUiOiJtYXh3ZWxsIiwiZW1haWwiOiIzMTU4OTE4MDgyQHFxLmNvbSIsInJvbGUiOiJ1c2VyIiwicGVybWlzc2lvbnMiOltdfQ.JX2dgQgcgyoYuAEfPobELYeWIkEyeLrHoay9jsykJkKbIqlLU_Kqy6UArEuyp2z1G9p5516cpeaFzohU9f7p_l5gzgJ0fmDGWTEqDytaFmOuN5aAVyOZ1HHKlo-sRBnu9Qae_yKSgSbI23s1hAEJwz6H-nW3oFxytPllX-UtyhA-LzTjpz-tH_4glVE57uz_TL4LKyMyFqRIBQCJD6CnTs9Lx-pqK0Q_u4HcNfh4JXCbA1eiRwYD7jv7Ej_SNLgl5eBygGhSofT64QAWkAICirOa3VkSRzQAZIQOsYzoIa6q845MFZAdtgm0pRFq5aiL0g4lBSpz8q0JHw52uh_dPA";

        function parseJwtPayload(token) {
            try {
                const parts = token.split('.');
                if (parts.length !== 3) {
                    return null;
                }

                const payload = parts[1];
                // Add padding if needed
                const paddedPayload = payload + '='.repeat((4 - payload.length % 4) % 4);
                const decoded = atob(paddedPayload);
                return JSON.parse(decoded);
            } catch (error) {
                console.error('Failed to parse JWT payload:', error);
                return null;
            }
        }

        function parseJwtHeader(token) {
            try {
                const parts = token.split('.');
                if (parts.length !== 3) {
                    return null;
                }

                const header = parts[0];
                // Add padding if needed
                const paddedHeader = header + '='.repeat((4 - header.length % 4) % 4);
                const decoded = atob(paddedHeader);
                return JSON.parse(decoded);
            } catch (error) {
                console.error('Failed to parse JWT header:', error);
                return null;
            }
        }

        function isTokenExpired(payload) {
            const now = Math.floor(Date.now() / 1000);
            return payload.exp < now;
        }

        function formatTimestamp(timestamp) {
            return new Date(timestamp * 1000).toLocaleString();
        }

        function analyzeToken() {
            const header = parseJwtHeader(realToken);
            const payload = parseJwtPayload(realToken);
            
            if (!header || !payload) {
                document.getElementById('tokenAnalysis').innerHTML = `
                    <div class="container error">
                        <h3>Token Analysis Failed</h3>
                        <p>Unable to parse the JWT token.</p>
                    </div>
                `;
                return;
            }

            const isExpired = isTokenExpired(payload);
            const timeUntilExpiry = payload.exp - Math.floor(Date.now() / 1000);
            
            document.getElementById('tokenAnalysis').innerHTML = `
                <div class="grid">
                    <div class="container ${isExpired ? 'error' : 'success'}">
                        <h3>Token Status</h3>
                        <p><strong>Valid:</strong> ${!isExpired ? 'Yes' : 'No (Expired)'}</p>
                        <p><strong>Issued:</strong> ${formatTimestamp(payload.iat)}</p>
                        <p><strong>Expires:</strong> ${formatTimestamp(payload.exp)}</p>
                        <p><strong>Time until expiry:</strong> ${timeUntilExpiry > 0 ? Math.floor(timeUntilExpiry / 60) + ' minutes' : 'Expired'}</p>
                    </div>

                    <div class="container info">
                        <h3>Header</h3>
                        <pre>${JSON.stringify(header, null, 2)}</pre>
                    </div>

                    <div class="container info">
                        <h3>User Information</h3>
                        <p><strong>User ID:</strong> ${payload.user_id}</p>
                        <p><strong>Username:</strong> ${payload.username}</p>
                        <p><strong>Email:</strong> ${payload.email}</p>
                        <p><strong>Role:</strong> ${payload.role}</p>
                        <p><strong>Permissions:</strong> ${payload.permissions.length > 0 ? payload.permissions.join(', ') : 'None'}</p>
                    </div>

                    <div class="container info">
                        <h3>Token Claims</h3>
                        <p><strong>Issuer:</strong> ${payload.iss}</p>
                        <p><strong>Audience:</strong> ${payload.aud}</p>
                        <p><strong>Subject:</strong> ${payload.sub}</p>
                        <p><strong>Type:</strong> ${payload.type}</p>
                    </div>
                </div>

                <div class="container">
                    <h3>Full Payload</h3>
                    <pre>${JSON.stringify(payload, null, 2)}</pre>
                </div>

                <div class="container">
                    <h3>Token Sections</h3>
                    <div class="token-section">
                        <strong>Header:</strong><br>
                        ${realToken.split('.')[0]}
                    </div>
                    <div class="token-section">
                        <strong>Payload:</strong><br>
                        ${realToken.split('.')[1]}
                    </div>
                    <div class="token-section">
                        <strong>Signature:</strong><br>
                        ${realToken.split('.')[2]}
                    </div>
                </div>
            `;

            // Test ComfyUI integration
            testComfyUIIntegration(isExpired);
        }

        function testComfyUIIntegration(isExpired) {
            const comfyUIUrl = `http://localhost:5173/?token=${encodeURIComponent(realToken)}`;
            
            document.getElementById('comfyUITest').innerHTML = `
                <div class="container ${isExpired ? 'warning' : 'success'}">
                    <h3>ComfyUI Integration Test</h3>
                    ${isExpired ? 
                        '<p class="warning">⚠️ Token is expired. ComfyUI may not authenticate properly.</p>' : 
                        '<p class="success">✅ Token is valid and ready for ComfyUI integration.</p>'
                    }
                    <p><strong>ComfyUI URL:</strong></p>
                    <div class="token-section">
                        <a href="${comfyUIUrl}" target="_blank">${comfyUIUrl}</a>
                    </div>
                    <button onclick="window.open('${comfyUIUrl}', '_blank')">
                        Open ComfyUI with Token
                    </button>
                    <p><strong>Expected behavior in ComfyUI:</strong></p>
                    <ul>
                        <li>JWT authentication should initialize automatically</li>
                        <li>User "maxwell" should be logged in</li>
                        <li>Settings → User should show JWT user information</li>
                        <li>Role should display as "user"</li>
                        <li>Permissions array should be empty</li>
                    </ul>
                </div>
            `;
        }

        // Run analysis on page load
        window.onload = analyzeToken;
    </script>
</body>
</html>
