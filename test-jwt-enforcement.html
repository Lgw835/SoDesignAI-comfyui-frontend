<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JWT强制认证测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { border-left: 5px solid #28a745; }
        .warning { border-left: 5px solid #ffc107; }
        .error { border-left: 5px solid #dc3545; }
        .info { border-left: 5px solid #17a2b8; }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        
        .token-display {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            word-break: break-all;
            font-family: monospace;
            font-size: 11px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>🔒 JWT强制认证测试</h1>
    
    <div class="test-card info">
        <h3>📋 测试说明</h3>
        <p>此页面用于测试ComfyUI的强制JWT认证功能。</p>
        <p><strong>预期行为：</strong></p>
        <ul>
            <li>✅ 带有效JWT令牌的访问应该成功</li>
            <li>❌ 不带JWT令牌的访问应该被重定向到访问拒绝页面</li>
            <li>❌ 带无效JWT令牌的访问应该被重定向到访问拒绝页面</li>
            <li>❌ 带过期JWT令牌的访问应该被重定向到访问拒绝页面</li>
        </ul>
    </div>

    <div class="test-grid">
        <div class="test-card success">
            <h3>✅ 有效JWT令牌测试</h3>
            <p>使用真实的有效JWT令牌访问ComfyUI</p>
            <button onclick="testValidToken()" class="success">测试有效令牌</button>
            <div id="validTokenResult"></div>
        </div>

        <div class="test-card error">
            <h3>❌ 无JWT令牌测试</h3>
            <p>直接访问ComfyUI，不带任何令牌参数（应该显示访问拒绝页面）</p>
            <button onclick="testNoToken()" class="danger">测试无令牌访问</button>
            <div id="noTokenResult"></div>
        </div>

        <div class="test-card warning">
            <h3>⚠️ 无效JWT令牌测试</h3>
            <p>使用格式错误的JWT令牌访问ComfyUI</p>
            <button onclick="testInvalidToken()" class="danger">测试无效令牌</button>
            <div id="invalidTokenResult"></div>
        </div>

        <div class="test-card warning">
            <h3>⏰ 过期JWT令牌测试</h3>
            <p>使用已过期的JWT令牌访问ComfyUI</p>
            <button onclick="testExpiredToken()" class="danger">测试过期令牌</button>
            <div id="expiredTokenResult"></div>
        </div>
    </div>

    <div class="test-card info">
        <h3>🔧 手动测试</h3>
        <p>你也可以手动测试以下链接：</p>
        <div style="margin: 15px 0;">
            <p><strong>1. 无令牌访问（应该被拒绝）：</strong></p>
            <a href="http://localhost:5173/" target="_blank">http://localhost:5173/</a>
        </div>
        <div style="margin: 15px 0;">
            <p><strong>2. 有效令牌访问（应该成功）：</strong></p>
            <div class="token-display" id="validTokenLink">生成中...</div>
        </div>
        <div style="margin: 15px 0;">
            <p><strong>3. 无令牌访问测试：</strong></p>
            <a href="http://localhost:5173/" target="_blank">http://localhost:5173/</a>
            <p style="font-size: 12px; color: #666;">应该显示访问拒绝信息</p>
        </div>
    </div>

    <div class="test-card">
        <h3>📊 测试结果汇总</h3>
        <div id="testSummary">
            <p>点击上方按钮开始测试...</p>
        </div>
    </div>

    <script>
        // 真实的JWT令牌
        const realToken = "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJTb0Rlc2lnbi5BSSIsImF1ZCI6InNvZGVzaWduLXVzZXJzIiwic3ViIjoiNjgxYTJmZGFhMjZkY2ZhYWJkMzZjZjYxIiwiaWF0IjoxNzUxODczMDE0LCJleHAiOjE3NTE4NzQ4MTQsInR5cGUiOiJhY2Nlc3MiLCJ1c2VyX2lkIjoiNjgxYTJmZGFhMjZkY2ZhYWJkMzZjZjYxIiwidXNlcm5hbWUiOiJtYXh3ZWxsIiwiZW1haWwiOiIzMTU4OTE4MDgyQHFxLmNvbSIsInJvbGUiOiJ1c2VyIiwicGVybWlzc2lvbnMiOltdfQ.JX2dgQgcgyoYuAEfPobELYeWIkEyeLrHoay9jsykJkKbIqlLU_Kqy6UArEuyp2z1G9p5516cpeaFzohU9f7p_l5gzgJ0fmDGWTEqDytaFmOuN5aAVyOZ1HHKlo-sRBnu9Qae_yKSgSbI23s1hAEJwz6H-nW3oFxytPllX-UtyhA-LzTjpz-tH_4glVE57uz_TL4LKyMyFqRIBQCJD6CnTs9Lx-pqK0Q_u4HcNfh4JXCbA1eiRwYD7jv7Ej_SNLgl5eBygGhSofT64QAWkAICirOa3VkSRzQAZIQOsYzoIa6q845MFZAdtgm0pRFq5aiL0g4lBSpz8q0JHw52uh_dPA";

        let testResults = {
            validToken: null,
            noToken: null,
            invalidToken: null,
            expiredToken: null
        };

        function generateExpiredToken() {
            // 生成一个已过期的测试令牌
            const header = btoa(JSON.stringify({"alg": "HS256", "typ": "JWT"}));
            const payload = btoa(JSON.stringify({
                "iss": "SoDesign.AI",
                "aud": "sodesign-users",
                "sub": "test-user",
                "iat": Math.floor(Date.now() / 1000) - 7200, // 2小时前
                "exp": Math.floor(Date.now() / 1000) - 3600, // 1小时前过期
                "type": "access",
                "user_id": "test-user",
                "username": "测试用户",
                "email": "test@example.com",
                "role": "user",
                "permissions": []
            }));
            return `${header}.${payload}.fake-signature`;
        }

        function testValidToken() {
            const url = `http://localhost:5173/?token=${encodeURIComponent(realToken)}`;
            document.getElementById('validTokenResult').innerHTML = `
                <div class="result">
                    <strong>测试URL:</strong><br>
                    ${url}<br><br>
                    <strong>预期结果:</strong> 应该成功加载ComfyUI界面<br>
                    <strong>操作:</strong> 在新窗口中打开...
                </div>
            `;
            window.open(url, '_blank');
            testResults.validToken = 'tested';
            updateSummary();
        }

        function testNoToken() {
            const url = 'http://localhost:5173/';
            document.getElementById('noTokenResult').innerHTML = `
                <div class="result">
                    <strong>测试URL:</strong><br>
                    ${url}<br><br>
                    <strong>预期结果:</strong> 应该显示访问拒绝信息<br>
                    <strong>操作:</strong> 在新窗口中打开...
                </div>
            `;
            window.open(url, '_blank');
            testResults.noToken = 'tested';
            updateSummary();
        }

        function testInvalidToken() {
            const invalidToken = 'invalid.jwt.token';
            const url = `http://localhost:5173/?token=${encodeURIComponent(invalidToken)}`;
            document.getElementById('invalidTokenResult').innerHTML = `
                <div class="result">
                    <strong>测试URL:</strong><br>
                    ${url}<br><br>
                    <strong>预期结果:</strong> 应该重定向到访问拒绝页面<br>
                    <strong>操作:</strong> 在新窗口中打开...
                </div>
            `;
            window.open(url, '_blank');
            testResults.invalidToken = 'tested';
            updateSummary();
        }

        function testExpiredToken() {
            const expiredToken = generateExpiredToken();
            const url = `http://localhost:5173/?token=${encodeURIComponent(expiredToken)}`;
            document.getElementById('expiredTokenResult').innerHTML = `
                <div class="result">
                    <strong>测试URL:</strong><br>
                    ${url}<br><br>
                    <strong>预期结果:</strong> 应该重定向到访问拒绝页面<br>
                    <strong>操作:</strong> 在新窗口中打开...
                </div>
            `;
            window.open(url, '_blank');
            testResults.expiredToken = 'tested';
            updateSummary();
        }

        function updateSummary() {
            const tested = Object.values(testResults).filter(r => r === 'tested').length;
            const total = Object.keys(testResults).length;
            
            document.getElementById('testSummary').innerHTML = `
                <p><strong>测试进度:</strong> ${tested}/${total} 项测试已执行</p>
                <p><strong>说明:</strong> 请检查新打开的窗口中的行为是否符合预期。</p>
                <ul>
                    <li>✅ 有效令牌测试: ${testResults.validToken ? '已执行' : '未执行'}</li>
                    <li>❌ 无令牌测试: ${testResults.noToken ? '已执行' : '未执行'}</li>
                    <li>❌ 无效令牌测试: ${testResults.invalidToken ? '已执行' : '未执行'}</li>
                    <li>❌ 过期令牌测试: ${testResults.expiredToken ? '已执行' : '未执行'}</li>
                </ul>
            `;
        }

        // 页面加载时生成有效令牌链接
        window.onload = function() {
            const validUrl = `http://localhost:5173/?token=${encodeURIComponent(realToken)}`;
            document.getElementById('validTokenLink').innerHTML = `
                <a href="${validUrl}" target="_blank">${validUrl}</a>
            `;
        };
    </script>
</body>
</html>
