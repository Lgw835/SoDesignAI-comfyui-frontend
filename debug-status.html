<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComfyUI JWT Debug Status</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .status-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-ok { border-left: 5px solid #28a745; }
        .status-warning { border-left: 5px solid #ffc107; }
        .status-error { border-left: 5px solid #dc3545; }
        .status-info { border-left: 5px solid #17a2b8; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover { background: #0056b3; }
        
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        
        .token-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ComfyUI JWT Authentication Debug Status</h1>
    
    <div class="status-card status-info">
        <h3>üîç Debug Information</h3>
        <p>This page helps diagnose JWT authentication issues in ComfyUI.</p>
        <p><strong>Current URL:</strong> <span id="currentUrl"></span></p>
        <p><strong>Has Token Parameter:</strong> <span id="hasToken"></span></p>
        <p><strong>Environment:</strong> Development Mode</p>
    </div>

    <div class="grid">
        <div class="status-card" id="fileStatus">
            <h3>üìÅ File Status</h3>
            <div id="fileChecks">Checking files...</div>
        </div>

        <div class="status-card" id="tokenStatus">
            <h3>üîë Token Status</h3>
            <div id="tokenInfo">Analyzing token...</div>
        </div>
    </div>

    <div class="status-card">
        <h3>üß™ Test JWT Token</h3>
        <p>Paste a JWT token to test:</p>
        <textarea class="token-input" id="testToken" rows="3" placeholder="Paste JWT token here..."></textarea>
        <br>
        <button onclick="testToken()">Test Token</button>
        <button onclick="useRealToken()">Use Real Token</button>
        <button onclick="openComfyUIWithToken()">Open ComfyUI with Token</button>
        <div id="testResults"></div>
    </div>

    <div class="status-card">
        <h3>üöÄ Quick Actions</h3>
        <button onclick="window.open('http://localhost:5173/', '_blank')">Open ComfyUI (No Token)</button>
        <button onclick="window.open('test-real-jwt.html', '_blank')">Open Token Analyzer</button>
        <button onclick="window.open('test-jwt.html', '_blank')">Open Test Generator</button>
        <button onclick="checkCORS()">Test CORS</button>
    </div>

    <script>
        // Real token for testing
        const realToken = "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJTb0Rlc2lnbi5BSSIsImF1ZCI6InNvZGVzaWduLXVzZXJzIiwic3ViIjoiNjgxYTJmZGFhMjZkY2ZhYWJkMzZjZjYxIiwiaWF0IjoxNzUxODczMDE0LCJleHAiOjE3NTE4NzQ4MTQsInR5cGUiOiJhY2Nlc3MiLCJ1c2VyX2lkIjoiNjgxYTJmZGFhMjZkY2ZhYWJkMzZjZjYxIiwidXNlcm5hbWUiOiJtYXh3ZWxsIiwiZW1haWwiOiIzMTU4OTE4MDgyQHFxLmNvbSIsInJvbGUiOiJ1c2VyIiwicGVybWlzc2lvbnMiOltdfQ.JX2dgQgcgyoYuAEfPobELYeWIkEyeLrHoay9jsykJkKbIqlLU_Kqy6UArEuyp2z1G9p5516cpeaFzohU9f7p_l5gzgJ0fmDGWTEqDytaFmOuN5aAVyOZ1HHKlo-sRBnu9Qae_yKSgSbI23s1hAEJwz6H-nW3oFxytPllX-UtyhA-LzTjpz-tH_4glVE57uz_TL4LKyMyFqRIBQCJD6CnTs9Lx-pqK0Q_u4HcNfh4JXCbA1eiRwYD7jv7Ej_SNLgl5eBygGhSofT64QAWkAICirOa3VkSRzQAZIQOsYzoIa6q845MFZAdtgm0pRFq5aiL0g4lBSpz8q0JHw52uh_dPA";

        function updateCurrentUrl() {
            document.getElementById('currentUrl').textContent = window.location.href;
            const urlParams = new URLSearchParams(window.location.search);
            const hasToken = urlParams.has('token');
            document.getElementById('hasToken').textContent = hasToken ? 'Yes' : 'No';
            document.getElementById('hasToken').style.color = hasToken ? 'green' : 'red';
        }

        async function checkFiles() {
            const files = [
                'user.css',
                'api/userdata/user.css',
                'comfyui_auth.js'
            ];

            let html = '';
            for (const file of files) {
                try {
                    const response = await fetch(file, { method: 'HEAD' });
                    const status = response.ok ? '‚úÖ' : '‚ùå';
                    const statusText = response.ok ? 'OK' : `Error ${response.status}`;
                    html += `<p>${status} ${file} - ${statusText}</p>`;
                } catch (error) {
                    html += `<p>‚ùå ${file} - Network Error</p>`;
                }
            }

            document.getElementById('fileChecks').innerHTML = html;
            document.getElementById('fileStatus').className = 'status-card status-ok';
        }

        function parseJwtPayload(token) {
            try {
                const parts = token.split('.');
                if (parts.length !== 3) return null;
                const payload = parts[1];
                const paddedPayload = payload + '='.repeat((4 - payload.length % 4) % 4);
                const decoded = atob(paddedPayload);
                return JSON.parse(decoded);
            } catch (error) {
                return null;
            }
        }

        function analyzeCurrentToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (!token) {
                document.getElementById('tokenInfo').innerHTML = '<p>‚ùå No token in URL</p>';
                document.getElementById('tokenStatus').className = 'status-card status-warning';
                return;
            }

            const payload = parseJwtPayload(token);
            if (!payload) {
                document.getElementById('tokenInfo').innerHTML = '<p>‚ùå Invalid token format</p>';
                document.getElementById('tokenStatus').className = 'status-card status-error';
                return;
            }

            const isExpired = payload.exp < Math.floor(Date.now() / 1000);
            const timeLeft = payload.exp - Math.floor(Date.now() / 1000);

            document.getElementById('tokenInfo').innerHTML = `
                <p>‚úÖ Token found and parsed</p>
                <p><strong>User:</strong> ${payload.username}</p>
                <p><strong>Email:</strong> ${payload.email}</p>
                <p><strong>Role:</strong> ${payload.role}</p>
                <p><strong>Expired:</strong> ${isExpired ? 'Yes' : 'No'}</p>
                <p><strong>Time left:</strong> ${timeLeft > 0 ? Math.floor(timeLeft / 60) + ' minutes' : 'Expired'}</p>
            `;
            
            document.getElementById('tokenStatus').className = `status-card ${isExpired ? 'status-error' : 'status-ok'}`;
        }

        function testToken() {
            const token = document.getElementById('testToken').value.trim();
            if (!token) {
                document.getElementById('testResults').innerHTML = '<p style="color: red;">Please enter a token</p>';
                return;
            }

            const payload = parseJwtPayload(token);
            if (!payload) {
                document.getElementById('testResults').innerHTML = '<p style="color: red;">Invalid token format</p>';
                return;
            }

            const isExpired = payload.exp < Math.floor(Date.now() / 1000);
            document.getElementById('testResults').innerHTML = `
                <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 10px;">
                    <h4>Token Analysis:</h4>
                    <pre>${JSON.stringify(payload, null, 2)}</pre>
                    <p><strong>Status:</strong> ${isExpired ? '‚ùå Expired' : '‚úÖ Valid'}</p>
                </div>
            `;
        }

        function useRealToken() {
            document.getElementById('testToken').value = realToken;
            testToken();
        }

        function openComfyUIWithToken() {
            const token = document.getElementById('testToken').value.trim() || realToken;
            const url = `http://localhost:5173/?token=${encodeURIComponent(token)}`;
            window.open(url, '_blank');
        }

        async function checkCORS() {
            try {
                const response = await fetch('http://192.168.1.17:5000/api/comfyui/verify_token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: 'test' })
                });
                alert('CORS test successful! Server is reachable.');
            } catch (error) {
                alert(`CORS test failed: ${error.message}\n\nThis is expected if the JWT verification server is not running.`);
            }
        }

        // Initialize on page load
        window.onload = function() {
            updateCurrentUrl();
            checkFiles();
            analyzeCurrentToken();
            document.getElementById('testToken').value = realToken;
        };
    </script>
</body>
</html>
